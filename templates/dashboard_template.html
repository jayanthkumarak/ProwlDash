<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Compliance Dashboard - Indupro</title>
    <style>
        /* Colorblind-friendly palette based on Okabe-Ito
           Reference: https://siegal.bio.nyu.edu/color-palette/
           Avoids red/green confusion, uses blue/orange as primary contrast */
        :root,
        [data-theme="dark"] {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-hover: #22222e;
            --border: #2a2a38;
            --border-active: #56B4E9;
            --text-primary: #f0f0f5;
            --text-secondary: #9090a0;
            --text-muted: #606070;

            --accent-blue: #56B4E9;

            --accent-green: #009E73;

            --accent-red: #D55E00;

            --accent-yellow: #F0E442;

            --accent-purple: #CC79A7;

            --accent-orange: #E69F00;


            --severity-critical: #D55E00;

            --severity-high: #E69F00;

            --severity-medium: #F0E442;

            --severity-low: #0072B2;
            --severity-low: #0072B2;



            --brand-primary: var(--accent-blue);
            --brand-secondary: var(--accent-purple);
        }

        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8ecf1;
            --bg-hover: #dfe4eb;
            --border: #d1d9e6;
            --border-active: #0072B2;
            --text-primary: #1a1f36;
            --text-secondary: #4a5568;
            --text-muted: #718096;

            --accent-blue: #0072B2;

            --accent-green: #009E73;

            --accent-red: #D55E00;

            --accent-yellow: #B8860B;

            --accent-purple: #CC79A7;

            --accent-orange: #E69F00;

            --severity-critical: #D55E00;
            --severity-high: #E69F00;
            --severity-medium: #B8860B;

            --severity-low: #0072B2;


            --brand-primary: var(--accent-blue);
            --brand-secondary: var(--accent-purple);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: 28px 40px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .header .subtitle strong {
            color: var(--accent-blue);
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 14px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .theme-toggle svg {
            width: 16px;
            height: 16px;
        }

        .tab-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 40px;
            display: flex;
            gap: 0;
        }

        .tab-bar.hidden {
            display: none;
        }

        .tab {
            padding: 14px 24px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .tab .tab-count {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .tab.active .tab-count {
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent-blue);
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 28px 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-hint {
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .btn-all {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 14px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-all:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-all.hidden {
            display: none;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
            margin-bottom: 16px;
        }

        .severity-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .summary-card:hover {
            border-color: var(--text-muted);
            transform: translateY(-2px);
        }

        .summary-card.active {
            border-color: var(--border-active);
            box-shadow: 0 0 0 1px var(--border-active);
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .summary-card.fail::before {
            background: var(--accent-red);
        }

        .summary-card.pass::before {
            background: var(--accent-green);
        }

        .summary-card.manual::before {
            background: var(--accent-yellow);
        }

        .summary-card.fixed::before {
            background: var(--accent-blue);
        }

        .summary-card.new-fail::before {
            background: var(--accent-purple);
        }

        .summary-card.critical::before {
            background: var(--severity-critical);
        }

        .summary-card.high::before {
            background: var(--severity-high);
        }

        .summary-card.medium::before {
            background: var(--severity-medium);
        }

        .summary-card.low::before {
            background: var(--severity-low);
        }

        .summary-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .summary-card.fail .summary-value {
            color: var(--accent-red);
        }

        .summary-card.pass .summary-value {
            color: var(--accent-green);
        }

        .summary-card.manual .summary-value {
            color: var(--accent-yellow);
        }

        .summary-card.fixed .summary-value {
            color: var(--accent-blue);
        }

        .summary-card.new-fail .summary-value {
            color: var(--accent-purple);
        }

        .summary-card.critical .summary-value {
            color: var(--severity-critical);
        }

        .summary-card.high .summary-value {
            color: var(--severity-high);
        }

        .summary-card.medium .summary-value {
            color: var(--severity-medium);
        }

        .summary-card.low .summary-value {
            color: var(--severity-low);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .summary-delta {
            margin-top: 10px;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .summary-delta.positive {
            background: rgba(61, 214, 140, 0.15);
            color: var(--accent-green);
        }

        .summary-delta.negative {
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
        }

        .summary-delta.neutral {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
        }

        .chart-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bar-label {
            width: 90px;
            font-size: 11px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bar-track {
            flex: 1;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .bar-fill.fail {
            background: var(--accent-red);
        }

        .bar-fill.critical {
            background: var(--severity-critical);
        }

        .bar-fill.high {
            background: var(--severity-high);
        }

        .bar-fill.medium {
            background: var(--severity-medium);
        }

        .bar-fill.low {
            background: var(--severity-low);
        }

        .bar-value {
            width: 45px;
            font-size: 11px;
            text-align: right;
            color: var(--text-muted);
        }

        .donut-container {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .donut {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .donut-center {
            position: absolute;
            width: 76px;
            height: 76px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .donut-center-value {
            font-size: 22px;
            font-weight: 700;
        }

        .donut-center-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.fail {
            background: var(--accent-red);
        }

        .legend-dot.pass {
            background: var(--accent-green);
        }

        .legend-dot.manual {
            background: var(--accent-yellow);
        }

        .filters-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            min-width: 130px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-reset {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        .btn-reset:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--brand-primary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .btn-link:hover {
            background: var(--bg-hover);
            text-decoration: underline;
        }

        .filter-toggle {
            display: inline-flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-left: 10px;
        }

        .filter-toggle button {
            background: transparent;
            border: none;
            padding: 6px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            border-right: 1px solid var(--border);
            transition: all 0.2s;
        }

        .filter-toggle button:last-child {
            border-right: none;
        }

        .filter-toggle button.active {
            background: var(--brand-primary);
            color: #fff;
        }

        .table-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;

        }

        .table-header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);

            position: sticky;

            z-index: 11;
        }

        .table-header h2 {
            font-size: 14px;
            font-weight: 600;
        }

        .result-info {
            font-size: 12px;
            color: var(--text-muted);
        }



        .table-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .table-scroll::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .table-scroll::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        thead {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);

            z-index: 10;
            box-shadow: 0 1px 0 var(--border);

        }

        th {
            padding: 10px 14px;
            text-align: left;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            resize: horizontal;
        }

        th:after {
            content: '';
            position: absolute;
            right: 0;
            top: 25%;
            height: 50%;
            width: 3px;
            cursor: col-resize;
            background: var(--border);
            opacity: 0;
            transition: opacity 0.2s;
        }

        th:hover:after {
            opacity: 1;
        }


        th:nth-child(1) {
            width: 100px;
        }


        th:nth-child(2) {
            width: auto;
            min-width: 300px;
        }


        th:nth-child(3) {
            width: 80px;
        }


        th:nth-child(4) {
            width: 80px;
        }


        th:nth-child(5) {
            width: 120px;
        }


        th:nth-child(6) {
            width: 90px;
        }


        td {
            padding: 12px 14px;
            font-size: 12px;
            border-bottom: 1px solid var(--bg-tertiary);
            vertical-align: top;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td:nth-child(2) {
            white-space: normal;
            word-wrap: break-word;
        }


        tbody tr {
            cursor: pointer;
            transition: background 0.1s;
        }

        tbody tr:hover {
            background: var(--bg-hover);
        }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.fail {
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
        }

        .badge.pass {
            background: rgba(61, 214, 140, 0.15);
            color: var(--accent-green);
        }

        .badge.manual {
            background: rgba(255, 217, 61, 0.15);
            color: var(--accent-yellow);
        }

        .badge-sm {
            padding: 2px 5px;
            font-size: 9px;
            margin-left: 4px;
        }

        .badge-sm.fixed {
            background: rgba(74, 158, 255, 0.2);
            color: var(--accent-blue);
        }

        .badge-sm.new {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
        }

        .severity-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-badge.critical {
            background: rgba(239, 68, 68, 0.15);
            color: var(--severity-critical);
        }

        .severity-badge.high {
            background: rgba(249, 115, 22, 0.15);
            color: var(--severity-high);
        }

        .severity-badge.medium {
            background: rgba(234, 179, 8, 0.15);
            color: var(--severity-medium);
        }

        .badge.l1 {
            background: rgba(0, 158, 115, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(0, 158, 115, 0.3);
        }

        .badge.l2 {
            background: rgba(230, 159, 0, 0.15);
            color: var(--accent-orange);
            border: 1px solid rgba(230, 159, 0, 0.3);
        }

        .badge.mitre {
            background: rgba(204, 121, 167, 0.15);
            color: var(--accent-purple);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .badge.mitre:hover {
            background: rgba(204, 121, 167, 0.3);
            text-decoration: underline;
        }

        .meta-badges {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .severity-badge.low {
            background: rgba(59, 130, 246, 0.15);
            color: var(--severity-low);
        }

        .account-tag {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }

        .account-tag.acct1 {
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent-blue);
        }

        .account-tag.acct2 {
            background: rgba(167, 139, 250, 0.15);
            color: var(--accent-purple);
        }

        .account-tag.acct3 {
            background: rgba(251, 146, 60, 0.15);
            color: var(--accent-orange);
        }

        .account-tag.acct4 {
            background: rgba(45, 212, 191, 0.15);
            color: #2dd4bf;
        }

        .service-tag {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .region-text {
            font-family: monospace;
            font-size: 10px;
            color: var(--text-muted);
        }

        .check-id {
            font-weight: 600;
            color: var(--text-primary);
        }

        .check-desc {
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 2px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #detailOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 100;
        }

        #detailModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border-radius: 10px;
            width: 90%;
            max-width: 860px;
            max-height: 85vh;
            overflow: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 15px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 22px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .detail-block {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 14px;
        }

        .detail-block.full {
            grid-column: 1 / -1;
        }

        .detail-block h4 {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .detail-block p {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .detail-block pre {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 250px;
            overflow-y: auto;
        }

        .detail-block code {
            background: var(--bg-primary);
            padding: 1px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }

        .detail-block a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .detail-block a:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-muted);
        }

        @media (max-width: 1100px) {
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .severity-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 700px) {
            .container {
                padding: 16px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .severity-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .filters-bar {
                flex-direction: column;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-left">
            <h1 id="dashboardTitle">Security Compliance Dashboard</h1>
            <div class="subtitle" id="headerSubtitle">Indupro AWS Accounts</div>
        </div>
        <button class="theme-toggle" id="themeToggle" title="Toggle dark/light mode">
            <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                style="display:none">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            <span id="themeLabel">Light</span>
        </button>
    </div>
    <span id="themeLabel">Light</span>
    </button>
    </div>
    <div class="tab-bar hidden" id="tabBar" role="tablist" aria-label="Account Tabs">
        <!-- Tabs will be dynamically generated -->
    </div>
    <div class="container" role="tabpanel">
        <div class="section-header">
            <div class="section-title">Executive Summary</div>
            <div style="display:flex;align-items:center;gap:16px;">
                <span class="section-hint" id="clickHint">Click cards to filter</span>
                <button class="btn-all hidden" id="btnShowAll">Show All</button>
            </div>
        </div>
        <div class="summary-grid" id="summaryGrid"></div>
        <div class="section-header">
            <div class="section-title">Severity Breakdown (Failures)</div>
        </div>
        <div class="severity-grid" id="severityGrid"></div>
        <div class="section-title" style="margin-bottom:14px">Analysis</div>
        <div class="charts-row" id="chartsRow"></div>
        <div class="section-title" style="margin-bottom:14px">Detailed Findings</div>
        <div class="filters-bar">
            <div class="filter-group">
                <label for="filterAccount">Account</label>
                <select id="filterAccount">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterStatus">Status</label>
                <select id="filterStatus">
                    <option value="">All</option>
                    <option value="FAIL">FAIL</option>
                    <option value="PASS">PASS</option>
                    <option value="MANUAL">MANUAL</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterSeverity">Severity</label>
                <select id="filterSeverity">
                    <option value="">All</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterRegion">Region</label>
                <select id="filterRegion">
                    <option value="">All Regions</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterService">Service</label>
                <select id="filterService">
                    <option value="">All Services</option>
                </select>
            </div>
            <div class="filter-toggle" id="filterLevel">
                <button class="active" data-val="">All Levels</button>
                <button data-val="Level 1">L1</button>
                <button data-val="Level 2">L2</button>
            </div>
            <div class="filter-group">
                <label for="filterDelta">Change</label>
                <select id="filterDelta">
                    <option value="">All</option>
                    <option value="fixed">Fixed</option>
                    <option value="new-fail">New Failures</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterSearch">Search</label>
                <input type="text" id="filterSearch" placeholder="ID, resource...">
            </div>
            <div class="filter-group hint-text" style="margin-left:auto; display:flex; gap:10px; align-items:center;">
                <span style="font-size:12px; font-weight:500; color:var(--text-muted)">Export:</span>
                <button onclick="exportCSV()" class="btn-link" title="Download CSV">CSV</button>
                <span style="color:var(--border)">|</span>
                <button onclick="exportPDF()" class="btn-link" id="btnExportPDF" title="Download PDF">PDF</button>
            </div>
            <button class="btn-reset" id="btnReset">Reset Filters</button>
        </div>
        <div class="table-section">
            <div class="table-header">
                <h2>Security Controls</h2>
                <span class="result-info" id="resultInfo"></span>
            </div>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Check ID</th>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Severity</th>
                            <th>Account</th>
                            <th>Service</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="detailOverlay">
        <div id="detailModal">
            <div class="modal-header">
                <h3 id="detailTitle"></h3>
                <button class="modal-close" id="closeDetail">&times;</button>
            </div>
            <div class="modal-body" id="detailBody"></div>
        </div>
    </div>
    <script>
        /*__DATA__*/

        let filtered = [];
        let activeCardFilter = null;
        let activeTab = 'all';
        const acctClasses = ['acct1', 'acct2', 'acct3', 'acct4'];

        function init() {
            initTheme();


            if (DATA.frameworkInfo) {
                const fw = DATA.frameworkInfo;
                const icon = fw.icon || 'üîç';
                const name = fw.full_name || fw.name || 'Security Compliance';
                document.title = name + ' Dashboard - Indupro';
                document.getElementById('dashboardTitle').textContent = icon + ' ' + name + ' Dashboard';
            }

            if (DATA.scanInfo) {
                document.getElementById('headerSubtitle').innerHTML =
                    'Indupro AWS Accounts | <strong>' + DATA.scanInfo + '</strong>';
            }


            if (DATA.isMultiAccount) {
                renderTabs();
            }

            renderSummary();
            renderSeverity();
            renderCharts();
            populateFilters();
            applyFilters();


            ['filterAccount', 'filterStatus', 'filterSeverity', 'filterRegion', 'filterService', 'filterDelta'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    clearCardFilter();
                    applyFilters();
                });
            });
            document.getElementById('filterSearch').addEventListener('input', debounce(() => {
                clearCardFilter();
                applyFilters();
            }, 150));


            document.querySelectorAll('#filterLevel button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('#filterLevel button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    clearCardFilter();
                    applyFilters();
                });
            });

            document.getElementById('btnExport').addEventListener('click', exportCSV);
            document.getElementById('btnReset').addEventListener('click', resetFilters);
            document.getElementById('btnShowAll').addEventListener('click', () => {
                clearCardFilter();
                resetFilters();
            });
            document.getElementById('closeDetail').addEventListener('click', closeModal);
            document.getElementById('detailOverlay').addEventListener('click', e => {
                if (e.target === e.currentTarget) closeModal();
            });
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);


            document.querySelectorAll('.summary-card').forEach(card => {

                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'button');
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        card.click();
                    }
                });

                card.addEventListener('click', () => {
                    document.getElementById('clickHint').style.display = 'none';
                });
            });
        }

        function initTheme() {
            const saved = localStorage.getItem('theme');
            const theme = saved || 'dark';
            setTheme(theme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
            localStorage.setItem('theme', next);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            const label = document.getElementById('themeLabel');
            if (theme === 'dark') {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
                label.textContent = 'Light';
            } else {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
                label.textContent = 'Dark';
            }
        }

        function debounce(fn, ms) {
            let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
        }

        function renderTabs() {
            const tabBar = document.getElementById('tabBar');
            tabBar.classList.remove('hidden');

            const accountIds = Object.keys(DATA.accounts);
            let html = `<div class="tab ${(activeTab === 'all' ? 'active' : '')}" 
                data-tab="all" 
                onclick="setTab('all')" 
                role="tab" 
                tabindex="0" 
                aria-selected="${activeTab === 'all'}"
                onkeydown="if(event.key==='Enter'||event.key===' ')setTab('all')">
                <span>All Accounts</span>
                <span class="tab-count">${DATA.stats.total}</span>
            </div>`;

            accountIds.forEach(acctId => {
                const acct = DATA.accounts[acctId];
                const isActive = activeTab === acctId;
                const acctStats = DATA.accountStats[acctId] || { total: 0 };
                html += `<div class="tab ${(isActive ? 'active' : '')}" 
                    data-tab="${acctId}" 
                    onclick="setTab('${acctId}')"
                    role="tab" 
                    tabindex="0"
                    aria-selected="${isActive}"
                    onkeydown="if(event.key==='Enter'||event.key===' ')setTab('${acctId}')">
                    <span>${acct.display || acct.name}</span>
                    <span class="tab-count">${acctStats.total}</span>
                </div>`;
            });

            tabBar.innerHTML = html;
        }

        function setTab(tabId) {
            if (activeTab === tabId) return;

            activeTab = tabId;


            document.querySelectorAll('.tab').forEach(t => {
                const isActive = t.dataset.tab === tabId;
                t.classList.toggle('active', isActive);
                t.setAttribute('aria-selected', isActive);
            });


            clearCardFilter();


            renderSummary();
            renderSeverity();
            renderCharts();
            applyFilters();
        }

        function getActiveStats() {
            if (activeTab === 'all') {
                return DATA.stats;
            }
            return DATA.accountStats[activeTab] || DATA.stats;
        }

        function getActiveFindings() {
            if (activeTab === 'all') {
                return DATA.findings;
            }
            return DATA.findings.filter(f => f.acctId === activeTab);
        }

        function clearCardFilter() {
            activeCardFilter = null;
            document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('active'));
            document.getElementById('btnShowAll').classList.add('hidden');
        }

        function setCardFilter(type, value) {
            if (activeCardFilter && activeCardFilter.type === type && activeCardFilter.value === value) {
                clearCardFilter();
                applyFilters();
                return;
            }
            activeCardFilter = { type, value };
            document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('btnShowAll').classList.remove('hidden');


            ['filterAccount', 'filterStatus', 'filterSeverity', 'filterRegion', 'filterService', 'filterDelta'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('filterSearch').value = '';

            applyFilters();
        }

        function renderSummary() {
            const s = getActiveStats();
            const cmp = DATA.stats.hasComparison && activeTab === 'all';
            document.getElementById('summaryGrid').innerHTML = `
                <div class="summary-card fail" onclick="setCardFilter('status', 'FAIL')">
                    <div class="summary-value">${s.fail}</div>
                    <div class="summary-label">Total Failures</div>
                    ${cmp ? `<div class="summary-delta ${s.failDelta < 0 ? 'positive' : s.failDelta > 0 ? 'negative' : 'neutral'}">
                        ${s.failDelta > 0 ? '+' : ''}${s.failDelta} from previous
                    </div>` : ''}
                </div>
                <div class="summary-card pass" onclick="setCardFilter('status', 'PASS')">
                    <div class="summary-value">${s.pass}</div>
                    <div class="summary-label">Total Passes</div>
                    ${cmp ? `<div class="summary-delta ${s.passDelta > 0 ? 'positive' : s.passDelta < 0 ? 'negative' : 'neutral'}">
                        ${s.passDelta > 0 ? '+' : ''}${s.passDelta} from previous
                    </div>` : ''}
                </div>
                <div class="summary-card manual" onclick="setCardFilter('status', 'MANUAL')">
                    <div class="summary-value">${s.manual}</div>
                    <div class="summary-label">Manual Reviews</div>
                </div>
                <div class="summary-card fixed" onclick="setCardFilter('delta', 'fixed')">
                    <div class="summary-value">${s.fixed}</div>
                    <div class="summary-label">Issues Fixed</div>
                    ${cmp ? '<div class="summary-delta positive">Remediated</div>' : ''}
                </div>
                <div class="summary-card new-fail" onclick="setCardFilter('delta', 'new-fail')">
                    <div class="summary-value">${s.newFail}</div>
                    <div class="summary-label">New Failures</div>
                    ${cmp && s.newFail > 0 ? '<div class="summary-delta negative">New</div>' : ''}
                </div>
            `;
        }

        function renderSeverity() {
            const s = getActiveStats();
            document.getElementById('severityGrid').innerHTML = `
                <div class="summary-card critical" onclick="setCardFilter('severity', 'critical')">
                    <div class="summary-value">${s.critical}</div>
                    <div class="summary-label">Critical</div>
                </div>
                <div class="summary-card high" onclick="setCardFilter('severity', 'high')">
                    <div class="summary-value">${s.high}</div>
                    <div class="summary-label">High</div>
                </div>
                <div class="summary-card medium" onclick="setCardFilter('severity', 'medium')">
                    <div class="summary-value">${s.medium}</div>
                    <div class="summary-label">Medium</div>
                </div>
                <div class="summary-card low" onclick="setCardFilter('severity', 'low')">
                    <div class="summary-value">${s.low}</div>
                    <div class="summary-label">Low</div>
                </div>
            `;
        }

        function renderCharts() {
            const s = getActiveStats();
            const failPct = s.total ? Math.round((s.fail / s.total) * 100) : 0;
            const passPct = s.total ? Math.round((s.pass / s.total) * 100) : 0;


            const byAcct = activeTab === 'all' ? DATA.byAccount : {};


            const activeFindings = getActiveFindings();
            const svcMap = {};
            activeFindings.forEach(f => {
                if (f.status === 'FAIL') {
                    const svc = f.service || 'Unknown';
                    svcMap[svc] = (svcMap[svc] || 0) + 1;
                }
            });
            const bySvc = Object.entries(svcMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6)
                .map(([name, fail]) => ({ name, fail }));
            const maxFails = bySvc.length ? Math.max(...bySvc.map(x => x.fail)) : 0;

            document.getElementById('chartsRow').innerHTML = `
                <div class="chart-card">
                    <div class="chart-title">Status Distribution</div>
                    <div class="donut-container">
                        <div class="donut" style="background: conic-gradient(
                            var(--accent-red) 0% ${failPct}%,
                            var(--accent-green) ${failPct}% ${failPct + passPct}%,
                            var(--accent-yellow) ${failPct + passPct}% 100%
                        );">
                            <div class="donut-center">
                                <div class="donut-center-value">${s.total}</div>
                                <div class="donut-center-label">Total</div>
                            </div>
                        </div>
                        <div class="donut-legend">
                            <div class="legend-item"><span class="legend-dot fail"></span>${s.fail} Fail (${failPct}%)</div>
                            <div class="legend-item"><span class="legend-dot pass"></span>${s.pass} Pass (${passPct}%)</div>
                            <div class="legend-item"><span class="legend-dot manual"></span>${s.manual} Manual</div>
                        </div>
                    </div>
                </div>
                ${activeTab === 'all' ? `<div class="chart-card">
                    <div class="chart-title">By Account</div>
                    <div class="bar-chart">
                        ${Object.entries(byAcct).map(([name, v]) => {
                const t = v.fail + v.pass;
                const fp = t ? Math.round((v.fail / t) * 100) : 0;
                return `<div class="bar-item">
                                <span class="bar-label">${name}</span>
                                <div class="bar-track"><div class="bar-fill fail" style="width:${fp}%"></div></div>
                                <span class="bar-value">${v.fail}/${t}</span>
                            </div>`;
            }).join('')}
                    </div>
                </div>` : `<div class="chart-card">
                    <div class="chart-title">Severity Distribution</div>
                    <div class="bar-chart">
                        ${[
                    { name: 'Critical', count: s.critical || 0, cls: 'critical' },
                    { name: 'High', count: s.high || 0, cls: 'high' },
                    { name: 'Medium', count: s.medium || 0, cls: 'medium' },
                    { name: 'Low', count: s.low || 0, cls: 'low' }
                ].map(sev => {
                    const maxSev = Math.max(s.critical || 0, s.high || 0, s.medium || 0, s.low || 0) || 1;
                    const w = Math.round((sev.count / maxSev) * 100);
                    return `<div class="bar-item">
                                <span class="bar-label">${sev.name}</span>
                                <div class="bar-track"><div class="bar-fill ${sev.cls}" style="width:${w}%"></div></div>
                                <span class="bar-value">${sev.count}</span>
                            </div>`;
                }).join('')}
                    </div>
                </div>`}
                <div class="chart-card">
                    <div class="chart-title">Top Failing Services</div>
                    <div class="bar-chart">
                        ${bySvc.map(x => {
                    const w = maxFails ? Math.round((x.fail / maxFails) * 100) : 0;
                    return `<div class="bar-item">
                                <span class="bar-label" title="${x.name}">${truncate(x.name, 12)}</span>
                                <div class="bar-track"><div class="bar-fill fail" style="width:${w}%"></div></div>
                                <span class="bar-value">${x.fail}</span>
                            </div>`;
                }).join('')}
                    </div>
                </div>
            `;
        }

        function populateFilters() {
            const acctSel = document.getElementById('filterAccount');
            Object.entries(DATA.accounts).forEach(([id, info]) => {
                acctSel.innerHTML += `<option value="${id}">${info.short} (${id.slice(-4)})</option>`;
            });
            const regSel = document.getElementById('filterRegion');
            (DATA.regions || []).forEach(r => {
                regSel.innerHTML += `<option value="${r}">${r}</option>`;
            });
            const svcSel = document.getElementById('filterService');
            (DATA.services || []).forEach(s => {
                svcSel.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function applyFilters() {
            let acct = document.getElementById('filterAccount').value;
            let status = document.getElementById('filterStatus').value;
            let severity = document.getElementById('filterSeverity').value;
            let region = document.getElementById('filterRegion').value;
            let service = document.getElementById('filterService').value;
            let delta = document.getElementById('filterDelta').value;
            let search = document.getElementById('filterSearch').value.toLowerCase();


            const activeLevelBtn = document.querySelector('#filterLevel button.active');
            const level = activeLevelBtn ? activeLevelBtn.dataset.val : '';


            if (activeCardFilter) {
                if (activeCardFilter.type === 'status') status = activeCardFilter.value;
                if (activeCardFilter.type === 'severity') {
                    severity = activeCardFilter.value;
                    status = 'FAIL';
                }
                if (activeCardFilter.type === 'delta') delta = activeCardFilter.value;
            }


            filtered = getActiveFindings().filter(r => {
                if (acct && r.acctId !== acct) return false;
                if (status && r.status !== status) return false;
                if (severity && r.severity !== severity) return false;
                if (region && r.region !== region) return false;
                if (service && r.service !== service) return false;
                if (delta && r.delta !== delta) return false;
                if (level && (!r.profile || !r.profile.includes(level))) return false;
                if (search) {
                    const hay = [
                        r.id, r.title, r.resource, r.resourceName, r.statusExt,
                        r.profile || '', r.mitre ? r.mitre.join(' ') : ''
                    ].join(' ').toLowerCase();


                    const terms = search.split(/\s+/);
                    return terms.every(term => hay.includes(term));
                }
                return true;
            });
            renderTable();
        }

        function resetFilters() {
            clearCardFilter();
            ['filterAccount', 'filterStatus', 'filterSeverity', 'filterRegion', 'filterService', 'filterDelta'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('filterSearch').value = '';
            applyFilters();
        }

        function getAcctClass(acctId) {
            const keys = Object.keys(DATA.accounts);
            const idx = keys.indexOf(acctId);
            return acctClasses[idx % acctClasses.length];
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const info = document.getElementById('resultInfo');
            info.textContent = `${filtered.length} results`;

            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No results</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map((r, i) => {
                const deltaTag = r.delta === 'fixed' ? '<span class="badge-sm fixed">FIXED</span>' :
                    r.delta === 'new-fail' ? '<span class="badge-sm new">NEW</span>' : '';
                let metaBadges = '';
                if (r.profile) {
                    const p = r.profile.toLowerCase();
                    if (p.includes('level 1')) metaBadges += '<span class="badge l1">L1</span>';
                    if (p.includes('level 2')) metaBadges += '<span class="badge l2">L2</span>';
                }
                if (r.mitre && r.mitre.length) {
                    metaBadges += '<div class="meta-badges">';
                    r.mitre.forEach(m => {

                        const url = `https://attack.mitre.org/techniques/${m.replace('.', '/')}/`;
                        metaBadges += `<a href="${url}" target="_blank" class="badge mitre" onclick="event.stopPropagation()">${m}</a>`;
                    });
                    metaBadges += '</div>';
                }
                const sevBadge = r.severity ? `<span class="severity-badge ${r.severity}">${r.severity}</span>` : '<span class="severity-badge">-</span>';
                return `<tr data-idx="${i}">
                    <td>
                        <span class="check-id">${esc(r.id)}</span>
                        <div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap">
                            ${metaBadges}
                        </div>
                    </td>
                    <td>
                        <div>${esc(truncate(r.title, 50))}</div>
                        <div class="check-desc">${esc(truncate(r.statusExt, 40))}</div>
                    </td>
                    <td><span class="badge ${r.status.toLowerCase()}">${r.status}</span>${deltaTag}</td>
                    <td>${sevBadge}</td>
                    <td><span class="account-tag ${getAcctClass(r.acctId)}">${DATA.accounts[r.acctId]?.short || r.acctId.slice(-6)}</span></td>
                    <td><span class="service-tag">${r.service || '-'}</span></td>
                </tr>`;
            }).join('');

            tbody.querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('click', () => showDetail(filtered[+tr.dataset.idx]));
            });
        }

        function showDetail(r) {
            document.getElementById('detailTitle').textContent = `${r.id} - ${truncate(r.title, 45)}`;
            const sevBadge = r.severity ? `<span class="severity-badge ${r.severity}">${r.severity.toUpperCase()}</span>` : '';
            document.getElementById('detailBody').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-block">
                        <h4>Status</h4>
                        <p>
                            <span class="badge ${r.status.toLowerCase()}">${r.status}</span>
                            ${r.delta === 'fixed' ? '<span class="badge-sm fixed">FIXED</span>' : ''}
                            ${r.delta === 'new-fail' ? '<span class="badge-sm new">NEW</span>' : ''}
                            ${r.oldStatus ? `<br><small style="color:var(--text-muted)">Was: ${r.oldStatus}</small>` : ''}
                        </p>
                    </div>
                    <div class="detail-block">
                        <h4>Severity</h4>
                        <p>${sevBadge || 'N/A'}</p>
                    </div>
                    <div class="detail-block">
                        <h4>Account & Region</h4>
                        <p>
                            <span class="account-tag ${getAcctClass(r.acctId)}">${DATA.accounts[r.acctId]?.short || r.acctId}</span>
                            <span style="margin:0 6px;color:var(--text-muted)">|</span>
                            <span class="region-text">${r.region}</span>
                        </p>
                    </div>
                    <div class="detail-block">
                        <h4>Service</h4>
                        <p><span class="service-tag">${r.service || 'N/A'}</span></p>
                    </div>
                    <div class="detail-block full">
                        <h4>Resource</h4>
                        <p><code>${esc(r.resource)}</code></p>
                        ${r.resourceName ? `<p style="margin-top:4px;color:var(--text-muted)">${esc(r.resourceName)}</p>` : ''}
                    </div>
                    <div class="detail-block full">
                        <h4>Status Details</h4>
                        <p>${esc(r.statusExt)}</p>
                    </div>
                    ${r.risk ? `<div class="detail-block full">
                        <h4>Risk</h4>
                        <p>${esc(r.risk)}</p>
                    </div>` : ''}
                    ${r.remediation ? `<div class="detail-block full">
                        <h4>Remediation</h4>
                        <pre>${esc(r.remediation)}</pre>
                        ${r.remediationUrl ? `<p style="margin-top:8px"><a href="${esc(r.remediationUrl)}" target="_blank">Documentation</a></p>` : ''}
                    </div>` : ''}
                </div>
            `;
            document.getElementById('detailOverlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailOverlay').style.display = 'none';
        }

        function esc(s) {
            if (!s) return '';
            return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function truncate(s, n) {
            if (!s) return '';
            return s.length > n ? s.slice(0, n) + '...' : s;
        }

        function exportCSV() {
            if (!filtered || !filtered.length) {
                alert('No data to export');
                return;
            }


            const cols = ['id', 'title', 'status', 'severity', 'acctId', 'region', 'service', 'resource', 'profile', 'mitre'];


            let csv = cols.join(',') + '\\n';


            filtered.forEach(r => {
                const row = cols.map(c => {
                    let val = r[c] || '';
                    if (Array.isArray(val)) val = val.join(' ');

                    val = String(val).replace(/"/g, '""');
                    return `"${val}"`;
                });
                csv += row.join(',') + '\\n';
            });


            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'prowldash_export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function exportPDF() {
            if (!window.jspdf || !window.html2canvas) {
                alert('PDF libraries not loaded. Please ensure internet access for PDF export.');
                return;
            }

            const btn = document.getElementById('btnExportPDF');
            const originalText = btn.textContent;
            btn.textContent = 'Generating...';
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();


                const addElement = async (selector, yOffset) => {
                    const el = document.querySelector(selector);
                    if (!el) return yOffset;

                    const canvas = await html2canvas(el, { scale: 1.5, useCORS: true, logging: false });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth - 20;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;


                    if (yOffset + imgHeight > pageHeight - 10) {
                        doc.addPage();
                        yOffset = 10;
                    }

                    doc.addImage(imgData, 'PNG', 10, yOffset, imgWidth, imgHeight);
                    return yOffset + imgHeight + 10;
                };

                let y = 10;

                doc.setFontSize(18);
                doc.text("ProwlDash Compliance Report", 10, y);
                y += 10;
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 10, y);
                y += 10;


                y = await addElement('.summary-grid', y);


                y = await addElement('#chartsRow', y);


                if (y > pageHeight - 30) {
                    doc.addPage();
                    y = 10;
                }
                doc.setFontSize(12);
                doc.text("Detailed Findings", 10, y);
                y += 10;
                doc.setFontSize(10);
                doc.text("Please refer to the interactive dashboard or CSV export for full findings list.", 10, y);

                doc.save('prowldash_report.pdf');
            } catch (err) {
                console.error(err);
                alert('Failed to generate PDF: ' + err.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }


        document.getElementById('btnExportPDF').addEventListener('click', exportPDF);

        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
</body>

</html>